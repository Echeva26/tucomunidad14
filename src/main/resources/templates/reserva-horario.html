<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Selección de horario</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="stylesheet" th:href="@{/static/css/reserva-padel.css}" />
</head>

<body>
  <!-- CABECERA -->
  <div class="cabecera">
    <span class="reserva-de-zonas">
      Selección de horario
    </span>
    <div class="container">
      <div class="tu-comunidad">
        TuComunidad
      </div>
      <p class="home">
        <a id="home-link" href="#" style="text-decoration: none;">
          <span class="home-sub-30">Home</span>
          <span></span>
        </a>
      </p>
      <div class="log-out">
        <span class="our-works">
          <a href="/" style="text-decoration: none;">Log out</a>
        </span>
      </div>
      <div class="usuario">
        Vecino
      </div>
    </div>
  </div>

  <!-- PAGINA -->
  <div class="pagina">
    <div class="container-6">
      <!-- PADEL -->
      <div class="elemento">
        <div class="borde-azul"></div>
        <div class="titulo">Zona Común</div>
        <!-- Agregar un campo de entrada para seleccionar el día -->
        <div class="container-select-dia">
          <label for="input-dia">Seleccionar día:</label>
          <input type="date" id="input-dia" onchange="cargarReservasPorDia()">
        </div>

        <!-- Elemento para mostrar el horario de reservas -->
        <div class="horario-reservas">
          <!-- Generar filas -->
          <div class="columnas-horas">
            <!-- Generar cuadrados por cada hora desde las 10:00:00 hasta las 22:00:00 -->
            <div th:each="hora : ${#numbers.sequence(10, 22)}" class="cuadrado-reserva">
              <span th:text="${hora + ':00:00'}"></span>
            </div>
          </div>
        </div>

      </div>
    </div>

    <div class="container-botones">

      <!-- BOTÓN CANCELAR RESERVA -->
      <div class="boton-cancelar" onclick="cancelarReserva()">
        <span class="texto-boton">Cancelar reserva</span>
      </div>

      <!-- BOTÓN RESERVAR -->
      <div class="boton-reservar">
        <span class="texto-boton">Reservar</span>
      </div>
    </div>
  </div>

  <!-- PIE DE PAGINA -->
  <div class="pie-de-pagina">
    <div class="container-5">
      <div class="image-2"></div>
      <div class="container-4">
        <img class="icon-1" th:src="@{/static/vectors/intagram.svg}" />
        <img class="icon-2" th:src="@{/static/vectors/facebook.svg}" />
        <img class="icon-3" th:src="@{/static/vectors/twitter.svg}" />
      </div>
      <div class="idioma">
        <span class="language">Idioma</span>
        <img class="icon-color" th:src="@{/static/vectors/flecha.svg}" />
      </div>
    </div>
    <div class="description" th:text="${descripcion}">
      Facilitamos la convivencia en tu comunidad
    </div>
    <div class="line"></div>
    <span class="tucom">©TuComunidad 2024</span>
  </div>

  <!-- Script para cargar las reservas por día -->
  <script>
    function cargarReservasPorDia() {
      var fechaSeleccionada = new Date(document.getElementById("input-dia").value);
      var areaComunId = obtenerParametroURL("idarea");
      var vecinoId = obtenerParametroURL("idvecino"); // Obtener el id del vecino de la URL

      // Obtener la fecha seleccionada en forma de timestamp
      var fechaSeleccionadaTimestamp = fechaSeleccionada.getTime();

      // Realizar la petición al servidor para obtener las reservas para el área común y día especificados
      fetch(`/reservasporidarea?idarea=${areaComunId}`)
        .then(response => response.json())
        .then(reservas => {
          var cuadrados = document.querySelectorAll(".cuadrado-reserva");

          // Limpiar las clases de reserva de todos los cuadrados
          cuadrados.forEach(cuadrado => {
            cuadrado.classList.remove("reserva-rojo");
            cuadrado.classList.remove("reserva-verde"); // Limpiar clases de reserva verde 
          });

          cuadrados.forEach(cuadrado => {
            var horaReserva = cuadrado.innerText.trim();

            // Obtener la hora de reserva en forma de timestamp
            var horaReservaTimestamp = new Date(fechaSeleccionada.getFullYear(), fechaSeleccionada.getMonth(), fechaSeleccionada.getDate(), horaReserva.split(":")[0], horaReserva.split(":")[1], horaReserva.split(":")[2]).getTime();

            // Verificar si hay alguna reserva que coincida con la fecha y hora seleccionadas
            var reserva = reservas.find(reserva => {
              var inicioReservaTimestamp = new Date(reserva.inicioReserva).getTime();
              var finReservaTimestamp = new Date(reserva.finReserva).getTime();
              return horaReservaTimestamp >= inicioReservaTimestamp && horaReservaTimestamp < finReservaTimestamp;
            });

            if (reserva) {
              // Verificar si la reserva pertenece al vecino actual
              if (reserva.idvecino == vecinoId) { // Cambiado a "==" para comparar valores sin tener en cuenta el tipo
                cuadrado.classList.add("reserva-verde"); // Agregar clase de reserva verde 
              } else {
                cuadrado.classList.add("reserva-rojo");
              }
            }
          });
        })
        .catch(error => console.error('Error al cargar las reservas:', error));
    }


    // Función para obtener parámetros de la URL
    function obtenerParametroURL(nombre) {
      nombre = nombre.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
      var regex = new RegExp('[\\?&]' + nombre + '=([^&#]*)');
      var resultados = regex.exec(location.search);
      return resultados === null ? '' : decodeURIComponent(resultados[1].replace(/\+/g, ' '));
    }

    // Función para cancelar una reserva y redirigir a la misma página
    function cancelarReserva() {
      var vecinoId = obtenerParametroURL("idvecino");
      var areaId = obtenerParametroURL("idarea");

      // Agregar animación de presionar el botón
      var botonCancelar = document.querySelector(".boton-cancelar");
      botonCancelar.classList.add("pressed");

      fetch(`/reservas/eliminarPorVecino/${vecinoId}`, {
          method: 'DELETE'
        })
        .then(response => {
          // Remover animación después de un breve retraso
          setTimeout(function() {
            botonCancelar.classList.remove("pressed");
            // Redirigir a la misma página con los parámetros idvecino e idarea
            window.location.href = `/reserva-horario?idvecino=${vecinoId}&idarea=${areaId}`;
          }, 300); // 300 milisegundos (ajusta según sea necesario)
          return response.text();
        })
        .then(message => {
          alert(message);
          // Aquí puedes añadir lógica adicional después de eliminar la reserva, como actualizar la visualización de las reservas
        })
        .catch(error => console.error('Error al cancelar la reserva:', error));
    }
  </script>

  <!-- Script para cambiar el texto del usuario -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      function getQueryParam(param) {
        var searchParams = new URLSearchParams(window.location.search);
        return searchParams.get(param);
      }

      // Cargar datos de las áreas comunes por tipo al cargar la página
      window.onload = function () {
        var idvecino = getQueryParam('idvecino'); // Obtiene el ID de vecino de la URL
        var tipodearea = getQueryParam('tipodearea'); // Obtiene el tipo de área de la URL

        document.getElementById('home-link').setAttribute('href', `/menucomunidad?idvecino=${idvecino}`);

        // Consultar si el vecino es un gestor
        fetch(`http://localhost:8080/vecinoporid?idvecino=${idvecino}`)
          .then(response => {
            if (!response.ok) {
              throw new Error('No se pudo obtener la información del vecino');
            }
            return response.json();
          })
          .then(data => {
            var gestor = data.gestor; // Obtener el parámetro gestor

            // Cambiar el texto en el elemento usuario dependiendo del parámetro gestor
            var usuarioElement = document.querySelector('.usuario');
            if (gestor) {
              usuarioElement.textContent = 'Gestor de Comunidad';
            } else {
              usuarioElement.textContent = 'Vecino';
            }
          })
          .catch(error => {
            console.error('Error:', error);
          });
      }
    });
  </script>

</body>

</html>
